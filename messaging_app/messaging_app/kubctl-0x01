#!/bin/bash

# kubctl-0x01.sh
# Script to scale Django app deployment in Kubernetes and test performance

DEPLOYMENT_NAME="django-messagingapp-deployment"
NAMESPACE="default"
SERVICE_NAME="django-messagingapp-service"

# Ensure kubectl is installed
if ! command -v kubectl &> /dev/null; then
    echo "Error: kubectl is not installed. Please install it first."
    exit 1
fi

# Ensure wrk is installed
if ! command -v wrk &> /dev/null; then
    echo "Error: wrk is not installed. Please install it (e.g., sudo apt install wrk)."
    exit 1
fi

echo "üìå Scaling deployment $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "‚è≥ Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

echo "‚úÖ Current pods running:"
kubectl get pods -n $NAMESPACE -o wide

# Get ClusterIP of service
CLUSTER_IP=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.clusterIP}')
PORT=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].port}')

echo "üåê Running load test with wrk on http://$CLUSTER_IP:$PORT ..."
wrk -t4 -c100 -d30s http://$CLUSTER_IP:$PORT/

echo "üìä Monitoring resource usage (pods, CPU, memory):"
kubectl top pods -n $NAMESPACE

